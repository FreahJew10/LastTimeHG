<h3>ForgotPass</h3>
@page "/forgetpassword"
@inject NavigationManager navigationManager
@inject IJSRuntime js
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject ProtectedSessionStorage MySession
@using Microsoft.AspNetCore.SignalR.Client
@using Models
@using DBL
@using Service
@using Blazored.Toast.Services
@inject IToastService ToastService
<BlazoredToasts />
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        background: #121212;
        color: #e0e0e0;
        font-family: 'Segoe UI', sans-serif;
    }

    .reset-card {
        background: #1e1e1e;
        padding: 2rem;
        border-radius: 1rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.7);
        width: 360px;
        margin: 3rem auto;
        transition: height .3s ease;
    }

        .reset-card h2 {
            text-align: center;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }

    .form-group {
        margin-bottom: 1rem;
    }

        .form-group label {
            display: block;
            margin-bottom: .5rem;
        }

        .form-group input {
            width: 100%;
            padding: .5rem;
            background: #2c2c2c;
            border: 1px solid #444;
            border-radius: .5rem;
            color: #e0e0e0;
            font-size: 1rem;
        }

            .form-group input:focus {
                outline: none;
                border-color: #6a69ce;
            }

    .btn {
        width: 100%;
        padding: .75rem;
        background: #6a69ce;
        border: none;
        border-radius: .5rem;
        color: #fff;
        font-size: 1rem;
        cursor: pointer;
        transition: background .2s;
    }

        .btn:hover {
            background: #5756a8;
        }

    .link-btn {
        background: none;
        color: #6a69ce;
        text-decoration: underline;
        font-size: .9rem;
        cursor: pointer;
        margin-top: .5rem;
        display: block;
        text-align: center;
    }

    .error-text {
        color: #e05c5c;
        font-size: .875rem;
        margin-top: .25rem;
    }
</style>

<div class="reset-card">
    @if (step == 1)
    {
        <h2>forgot password</h2>
        <div class="form-group">
            <label>אימייל</label>
            <input @bind="email" />
        </div>
        <button class="btn" @onclick="SendCode">sendcode</button>
    }
    else if (step == 2)
    {
        <h2>enter code</h2>
        <div class="form-group">
            <label>Verification code</label>
            <input @bind="putcode" />
        </div>
        <button class="btn" @onclick="VerifyCode">verify your cod</button>
        <button class="link-btn" @onclick="()=> step = 1">chnage email</button>
    }
    else if (step == 3)
    {
        <h2>define new password</h2>
        <div class="form-group">
            <label>new password</label>
            <input @bind="newPassword" type="password" />
        </div>
        <div class="form-group">
            <label>אימות סיסמה</label>
            <input @bind="confirmPassword" type="password" />
        </div>
        <button class="btn" @onclick="ResetPassword">submit new passord</button>
    }
    else if (step == 4)
    {
        <h2>הסיסמה עודכנה!</h2>
        <p style="text-align:center; margin-top:1rem;">תוכל להתחבר עם הסיסמה החדשה.</p>
    }
</div>

@code {
    int step = 1;
    string email;
    int code;
    string newPassword;
    string confirmPassword;
    int putcode = 0;
    Student userS = null;

    async Task SendCode()
    {
        if (string.IsNullOrEmpty(email))
        {

            ToastService.ShowError("must enter email");

            return;
        }
        studentDB studentDB = new studentDB();
        Student student = await studentDB.GetSudentByEmail(email);
        if (student != null)
        {
            code = new Random().Next(100000, 999999);

            try
            {
                var emailService = new EmailService();
                await emailService.SendEmailAsync(
                    email,
                    "Password Reset Request",
                    $"Your code : {code}",
                    "lirant108@gmail.com"
                );

                step = 2;
                ToastService.ShowSuccess("Code Sent");
            }
            catch (Exception ex)
            {
                ToastService.ShowError($"Error in Sending: {ex.Message}");
            }

        }
        else
        {
            ToastService.ShowError("email does not exist");
        }
    }

    async Task VerifyCode()
    {
        if (code == putcode)
        {
            step = 3;
        }
    }

    async Task ResetPassword()
    {
        studentDB studentDB = new studentDB();
        userS = await studentDB.GetSudentByEmail(email);
        Person newpass = userS;
        bool isStrongPassword = newPassword.Length >= 8 &&
                         newPassword.Any(char.IsUpper) &&
                         newPassword.Any(char.IsLower) &&
                         newPassword.Any(char.IsDigit) &&
                         newPassword.Any(ch => "!@#$%^&*()-_=+[{]}|;:'\",<.>/?".Contains(ch));
        if (isStrongPassword)
        {
            newpass.password = newPassword;
            if (await studentDB.updateAsync(newpass))
                ToastService.ShowSuccess("updated");
            else ToastService.ShowError("somthing went wrong");
        }
        else
        {
            ToastService.ShowError("Password must include upper, lower, number, special char, and be at least 8 chars.");
        }
    }
}