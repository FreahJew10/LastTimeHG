@page "/ViewTeacherProfileAndRequest/{Id:int}"
@using Models;
@using DBL;
@inject IJSRuntime js
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage

@inject ProtectedSessionStorage MySession
@inject Microsoft.AspNetCore.Components.NavigationManager navigationManager
@using Microsoft.AspNetCore.SignalR.Client
@using Blazored.Toast.Services

@inject IToastService ToastService

@if (privateteacher != null)
{
    <div class="teacher-appointment-container">
        <!-- Teacher Profile Section -->
        <div class="teacher-profile">
            <img src="data:image/jpeg;base64,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" alt="Teacher Photo" class="teacher-photo" />            <h2>@privateteacher.first_name @privateteacher.last_name </h2>
            <p>@privateteacher.bio</p>
            @if (subjects != null)
            {
                <p><strong>Expertise:</strong> @TeacherExpertise</p>
            }

            <strong>Rating:@CurrentRating</strong>
            <p style="font-size: 1.5rem; color: gold;">
                @GetStars(CurrentRating)
            </p>



        </div>

        <!-- Appointment Scheduler -->
        <div class="appointment-scheduler">
            <h3>Schedule a Private Lesson</h3>
            <div class="calendar">
                <label for="appointment-date">Select Date:</label>
                <input type="date" id="appointment-date" @bind="SelectedDate" />

                <label for="appointment-time">Select Time:</label>
                <input type="time" id="appointment-time" @bind="SelectedTime" />
            </div>
            <div class="appointment-form">
                <textarea placeholder="Additional Notes" maxlength="50" @bind="name"></textarea>
                <button class="btn-confirm" @onclick="ConfirmAppointment">Confirm Appointment</button>
                <button class="btn-invite" @onclick="ToggleSidebar">Invite Friends</button>
            </div>
        </div>

        <!-- Sidebar for Inviting Friends -->
        <div class="sidebar-overlay" style="@(IsSidebarOpen ? "display: block;" : "display: none;")" @onclick="ToggleSidebar"></div>
        <div class="sidebar" style="@(IsSidebarOpen ? "right: 0;" : "right: -300px;")">
            <h3>Invite Friends</h3>
            <button class="close-btn" @onclick="ToggleSidebar">✖</button>
            <div class="friends-list">
                @foreach (Person friend in my_friends_that_im_their_friend_to)
                {
                    <div class="friend-item">
                        <input type="checkbox" @onchange="(e) => ToggleFriendSelection(friend, e.Value as bool?)" />
                        <label>@friend.first_name @friend.last_name</label>
                    </div>
                }
            </div>

        </div>

        <!-- Rating Section -->
        <div class="rating-section">
            <h3>Rate This Teacher</h3>
            <div class="rating-stars">
                @for (int i = 1; i <= 5; i++)
                {
                    // capture a fresh variable
                    int starValue = i;

                    <span class="star"
                          style="cursor: pointer;"
                          @onclick="() => SubmitRating(starValue)"
                          @onmouseover="() => hoveredRating = starValue"
                          @onmouseout="() => hoveredRating = null">
                        @(
                            (hoveredRating.HasValue
                            ? starValue <= hoveredRating.Value
                            : starValue <= CurrentRating)
                            ? "⭐"
                            : "☆"
                            )
                    </span>
                }
            </div>
        </div>



    </div>
    <style>
        body {
            background-color: #111827;
            color: #f9fafb;
            font-family: Arial, sans-serif;
        }

        .teacher-appointment-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 24px;
            max-width: 900px;
            margin: 40px auto;
            background: #1e293b;
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .teacher-profile {
            text-align: center;
            margin-bottom: 24px;
        }

        .teacher-photo {
            width: 130px;
            height: 130px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 12px;
            border: 3px solid #3b82f6;
        }

        .teacher-profile h2 {
            margin: 10px 0;
            font-size: 1.8rem;
            color: #60a5fa;
        }

        .teacher-profile p {
            margin: 8px 0;
            font-size: 1rem;
            color: #d1d5db;
        }

        .appointment-scheduler,
        .rating-section {
            background: #2c3e50;
            padding: 20px;
            border-radius: 10px;
            width: 100%;
            margin-bottom: 24px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

            .appointment-scheduler h3,
            .rating-section h3 {
                text-align: center;
                color: #60a5fa;
                margin-bottom: 16px;
                font-size: 1.4rem;
            }

        .calendar {
            display: grid;
            gap: 16px;
            margin-bottom: 16px;
        }

            .calendar label {
                font-weight: 600;
                font-size: 0.95rem;
            }

            .calendar input[type="date"],
            .calendar input[type="time"],
            .appointment-form textarea {
                width: 100%;
                padding: 10px;
                border: 1px solid #374151;
                border-radius: 6px;
                background: #1f2937;
                color: #f9fafb;
                font-size: 1rem;
            }

        .appointment-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

            .appointment-form button {
                background-color: #3b82f6;
                color: white;
                border: none;
                padding: 10px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 1rem;
                transition: background-color 0.3s ease;
            }

                .appointment-form button:hover {
                    background-color: #60a5fa;
                }

        .btn-invite {
            background-color: #10b981;
        }

            .btn-invite:hover {
                background-color: #34d399;
            }

        .rating-stars {
            display: flex;
            justify-content: center;
            margin-top: 12px;
        }

            .rating-stars .star {
                font-size: 2rem;
                margin: 0 6px;
                color: #fbbf24;
                cursor: pointer;
                transition: transform 0.2s, color 0.2s;
            }

                .rating-stars .star:hover {
                    transform: scale(1.3);
                    color: #facc15;
                }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            right: -300px;
            width: 300px;
            height: 100%;
            background: #1f2937;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.5);
            padding: 20px;
            transition: right 0.3s ease-in-out;
            overflow-y: auto;
            z-index: 1000;
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            z-index: 999;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 22px;
            color: #f9fafb;
            cursor: pointer;
            position: absolute;
            right: 15px;
            top: 15px;
        }

        .friends-list {
            margin-top: 20px;
        }

        .friend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            font-size: 0.95rem;
            color: #f9fafb;
        }

        .btn-invite-confirm {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
            width: 100%;
            margin-top: 10px;
        }

            .btn-invite-confirm:hover {
                background-color: #60a5fa;
            }

        p strong {
            color: #60a5fa;
        }
    </style>


}

@code {
    private int? hoveredRating = null;  // tracks which star you’re over
                                        // Data Binding
    private string TeacherExpertise = "";
    [Parameter] public int id { get; set; }
    private DateTime? SelectedDate { get; set; }
    private DateTime? SelectedTime { get; set; } = new DateTime();
    private string StudentName;
    private string name;
    public Teacher privateteacher = null;
    private bool ShowSummary = false;
    private List<Subject> subjects = new List<Subject>();
    public Student userS = null;
    teacherDB teacherDB = new teacherDB();
    SubjectDB subjectDB = new SubjectDB();
    EventDB eventDB = new EventDB();
    friendsDB friendsDB = new friendsDB();
    StudentInEventDB studentInEventDB = new StudentInEventDB();

    List<Person> my_friends_that_im_their_friend_to = new List<Person>();
    private HubConnection hubConnection;

    // Rating Data
    private double CurrentRating = 0;

    private double yourCurrentRatingForThisteacher = 0;

    private bool IsSidebarOpen = false;
    private List<Person> SelectedFriends = new List<Person>();

    private async void ToggleSidebar()
    {
        my_friends_that_im_their_friend_to = await friendsDB.GiveAll_AreWeBothFriends_(userS);
        IsSidebarOpen = !IsSidebarOpen;
        StateHasChanged();
    }
    private void ToggleFriendSelection(Person friend, bool? isChecked)
    {
        if (isChecked == true)
        {
            SelectedFriends.Add(friend);
        }
        else
        {
            SelectedFriends.Remove(friend);
        }
    }


    protected override async Task OnParametersSetAsync()
    {
        if (id == null)
            id = 0;

        privateteacher = await teacherDB.GetTeacherByPrimeryKey(id);
        await GetRatet();
        await Getexp();
        // subjects = await subjectDB.SelectAllSubjectForTeacher(id);


        StateHasChanged();
    }
    private async Task Getexp()
    {
        List<Subject> subjects = await subjectDB.SelectAllSubjectForTeacher(id);
        foreach (Subject subject in subjects)
        {
            TeacherExpertise += $" {subject.subjectName}";
        }

    }
    private async Task GetRatet()
    {

        doubleDBforRate rateProvider = new doubleDBforRate();
        DoubleRate rateResult = await rateProvider.GetRate(privateteacher.Id);
        CurrentRating = rateResult?.Rate ?? 0;
    }
    private async void ConfirmAppointment()
    {
        hubConnection = new HubConnectionBuilder()
     .WithUrl(navigationManager.ToAbsoluteUri("/NotificationHub"))
     .WithAutomaticReconnect()
     .Build();
        await hubConnection.StartAsync();
        if (!string.IsNullOrEmpty(name))
        {
            if (SelectedDate != null && !string.IsNullOrEmpty(SelectedTime.ToString()) && !string.IsNullOrEmpty(userS.email))
            {
                List<StudentInEvent> studentInEvent = new List<StudentInEvent>();
                DateTime dateTime = new DateTime();

                dateTime = new DateTime(SelectedDate.Value.Year, SelectedDate.Value.Month, SelectedDate.Value.Day, SelectedTime.Value.Hour, SelectedTime.Value.Minute, 0);
                if (dateTime > DateTime.Now)
                {
                    try
                    {
                        string zeevhashcode = "daliner is the next one";
                        Random random = new Random();

                        int randomeventcod = zeevhashcode.GetHashCode() + random.Next(-20, 100);



                        Event @event = new Event($@"{name}/{dateTime.ToString("yyyy-MM-dd HH:mm")}", DateTime.Now, privateteacher.Id, "notification-private lesson", randomeventcod, DateTime.Today.AddHours(DateTime.Now.Hour + 1));
                        if (await eventDB.insertEvent(@event))
                        {

                            studentInEvent.Add(new StudentInEvent(userS.Id, randomeventcod));
                            foreach (Person friend in SelectedFriends)
                            {
                                studentInEvent.Add(new StudentInEvent(friend.Id, randomeventcod));
                            }
                            await studentInEventDB.insertStedentInEvent(studentInEvent);
                            ShowSummary = true;
                            await hubConnection.SendAsync("SendNotificationToInformTeacherThatIwantPrivateClass", "notification -private lesson", userS.email, privateteacher.email, @event.randomuniqcode);

                            await js.InvokeVoidAsync("alert", $"the request for private lesson was sent");
                        }

                    }
                    catch (Exception e)
                    {
                        Console.WriteLine("the error " + e);
                    }
                }
                else
                {
                    ToastService.ShowError("You can not enter date before today");
                }
            }
            else
            {
                // Handle error - Display a message to fill all fields
            }
        }
        else
        {
            await js.InvokeVoidAsync("alert", $"enter the name for the lesson (please try the the name will be uniqe for your one good)");
        }
    }

    private async void SubmitRating(int rating)
    {
        Rate rate = new Rate(rating, privateteacher.Id, userS.Id);
        RateDB rateDB = new RateDB();
        if (await rateDB.SubmitRate(rate))
        {
            ToastService.ShowSuccess("rate submited");
            await GetRatet();
        }
        else
        {
            ToastService.ShowError("something went wrong");
        }

        StateHasChanged();
    }

    private void FinalizeAppointment()
    {
        // Example: Save appointment to database or navigate to confirmation page
    }
    private bool _loadedExtras;
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_loadedExtras)
        {
            var user1 = await MySession.GetAsync<Student>("student");
            if (user1.Success)
            {
                userS = user1.Value;
                doubleDBforRate doubleDBforRate = new doubleDBforRate();
                // RateDB rateDB = new RateDB();
                // Rate r = await rateDB.GetMyRate(userS.Id, id);
                // yourCurrentRatingForThisteacher = r.rate;
                // DoubleRate rateResult = await doubleDBforRate.GetRate(privateteacher.Id);
                // CurrentRating = rateResult?.Rate ?? 0;
            }


            StateHasChanged();
            _loadedExtras = true;


            // now load rating and subjects

            //    subjects = await subjectDB.SelectAllSubjectForTeacher(privateteacher.Id);
            // if (subjects != null)
            //     foreach (Subject subject in subjects)
            //     {

            //         TeacherExpertise += $"{subject.subjectName} ";
            //     }
            // trigger a second render so your data-bound UI updates
            StateHasChanged();
        }
    }
    private string GetStars(double rating)
    {
        int full = (int)Math.Floor(rating);
        bool half = rating - full >= 0.5;
        int empty = 5 - full - (half ? 1 : 0);

        return new string('★', full) + (half ? "⯪" : "") + new string('☆', empty);
    }

}

