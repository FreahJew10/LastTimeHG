@page "/ViewTeacherProfileAndRequest/{Id:int}"
@using Models;
@using DBL;
@inject IJSRuntime js
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage

@inject ProtectedSessionStorage MySession
@inject Microsoft.AspNetCore.Components.NavigationManager navigationManager
@using Microsoft.AspNetCore.SignalR.Client


@if (privateteacher != null)
{
    <div class="teacher-appointment-container">
        <!-- Teacher Profile Section -->
        <div class="teacher-profile">
            <img src="data:image/jpeg;base64,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" alt="Teacher Photo" class="teacher-photo" />            <h2>@privateteacher.first_name @privateteacher.last_name </h2>
            <p>@privateteacher.bio</p>
            <p><strong>Expertise:</strong> @TeacherExpertise</p>
            <p><strong>Rating:</strong> ⭐⭐⭐⭐⭐ (4.8)</p>
        </div>

        <!-- Appointment Scheduler -->
        <div class="appointment-scheduler">
            <h3>Schedule a Private Lesson</h3>
            <div class="calendar">
                <label for="appointment-date">Select Date:</label>
                <input type="date" id="appointment-date" @bind="SelectedDate" />

                <label for="appointment-time">Select Time:</label>
                <input type="time" id="appointment-time" @bind="SelectedTime" />
            </div>
            <div class="appointment-form">
                <textarea placeholder="Additional Notes" @bind="Notes"></textarea>
                <button class="btn-confirm" @onclick="ConfirmAppointment">Confirm Appointment</button>
            </div> 
        </div>

        <!-- Rating Section -->
        <div class="rating-section">
            <h3>Rate This Teacher</h3>
            <div class="rating-stars">
                @for (int i = 1; i <= 5; i++)
                {
                    <span class="star" @onclick="@(() => SubmitRating(i))" style="cursor: pointer;">
                        @(i <= CurrentRating ? "⭐" : "☆")
                    </span>
                }
            </div>
            <p>Current Rating: @CurrentRating</p>
        </div>

        <!-- Summary -->
        @if (ShowSummary)
        {
            <div class="appointment-summary">
                <h4>Appointment Summary</h4>
                <p><strong>Date:</strong> @SelectedDate?.ToString()</p>
                <p><strong>Time:</strong> @SelectedTime?.ToString()</p>
                <p><strong>Student:</strong> @StudentName</p>

                <button class="btn-finalize" @onclick="FinalizeAppointment">Finalize</button>
            </div>
        }
    </div>
}

@code {
    // Data Binding
    private string TeacherExpertise = "";
    [Parameter] public int id { get; set; }
    private DateTime? SelectedDate { get; set; }
    private DateTime? SelectedTime { get; set; } = new DateTime();
    private string StudentName;
    private string Notes;
    public teacher privateteacher = null;
    private bool ShowSummary = false;
    private List<Subject> subjects = new List<Subject>();
    public Student userS = null;
    teacherDB teacherDB = new teacherDB();
    SubjectDB subjectDB = new SubjectDB();
    EventDB eventDB = new EventDB();
    StudentInEventDB studentInEventDB = new StudentInEventDB();

    // Rating Data
    private int CurrentRating = 0;

    protected override async void OnParametersSet()
    {
        if (id == 0)
            return;

        privateteacher = await teacherDB.GetTeacherByPrimeryKey(id);
        subjects = await subjectDB.SelectAllSubjectForTeacher(id);
        foreach (Subject subject in subjects)
        {
            TeacherExpertise += $"{subject.subjectName} ";
        }
        StateHasChanged();
    }

    private async void ConfirmAppointment()
    {
        if (SelectedDate != null && !string.IsNullOrEmpty(SelectedTime.ToString()) && !string.IsNullOrEmpty(userS.email))
        {
            try
            {
                string zeevhashcode = "daliner is the next one";
                int randomeventcod = zeevhashcode.GetHashCode();

                DateTime dateTime = new DateTime();

                dateTime = new DateTime(SelectedDate.Value.Year, SelectedDate.Value.Month, SelectedDate.Value.Day, SelectedTime.Value.Hour, SelectedTime.Value.Minute, 0);

                Event @event = new Event($@"//{Notes}// {dateTime.ToString("yyyy-MM-dd HH:mm")}", DateTime.Now, privateteacher.Id, "notification-private lesson", randomeventcod, DateTime.Today.AddHours(DateTime.Now.Hour + 1));
               if( await eventDB.insertEvent(@event))
               {
                StudentInEvent studentInEvent = new StudentInEvent(userS.Id, randomeventcod);

                await studentInEventDB.insertStedentInEvent(studentInEvent);
                    ShowSummary = true;
                    await js.InvokeVoidAsync("alert", $"the request for private lesson was sent");
               }
                
            }
            catch(Exception e){
                Console.WriteLine("the error "+e);
            }
        
        }
        else
        {
            // Handle error - Display a message to fill all fields
        }
    }

    private async void SubmitRating(int rating)
    {
        CurrentRating = rating;
        // await teacherDB.UpdateTeacherRating(privateteacher.Id, CurrentRating); // Save rating to DB
        StateHasChanged();
    }

    private void FinalizeAppointment()
    {
        // Example: Save appointment to database or navigate to confirmation page
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var user1 = await MySession.GetAsync<Student>("student");
            if (user1.Success)
            {
                userS = user1.Value;
                StateHasChanged();
            }
        }
    }
}

<style>
    .teacher-appointment-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        font-family: Arial, sans-serif;
        background-color: #f9f9f9;
        max-width: 800px;
        margin: auto;
    }

    .teacher-profile {
        text-align: center;
        margin-bottom: 20px;
    }

    .teacher-photo {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 10px;
    }

    .appointment-scheduler, .rating-section {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        width: 100%;
        margin-bottom: 20px;
    }

    .rating-stars {
        display: flex;
        justify-content: center;
        margin-top: 10px;
    }

        .rating-stars .star {
            font-size: 24px;
            margin: 0 5px;
            color: #FFD700; /* Gold color */
        }

            .rating-stars .star:hover {
                color: #FFAA00; /* Hover effect */
            }
</style>
