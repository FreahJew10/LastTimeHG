@inject NavigationManager navigationManager
@inject IJSRuntime js
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject ProtectedSessionStorage MySession
@inject Microsoft.AspNetCore.Components.NavigationManager navigationManager
@using Microsoft.AspNetCore.SignalR.Client
@using Models
@using DBL
@using Hubs
@inject IToastService ToastService

@page "/DetailsOfDay/{Date}"

@if (events != null)
{
    <div class="details-container">
        @*  <h4>Events for @selectedDate.ToString("dddd, MMM dd, yyyy")</h4> *@

        @if(events!=null)
        {
            <table class="events-table">
                <thead>
                    <tr>
                        <th>Event Name</th>
                        <th>Time</th>
                        <th>Kind of Event</th>
                        <th>Teacher ID</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (Event ev in events)
                    {
                        <tr>
                            <td>@ev.eventname</td>
                            <td>@ev.date.ToString("HH:mm")</td>
                            <td>@ev.kinofevent</td>
                            <td>@ev.teacherid</td>

                        </tr>
                    }
                </tbody>
            </table>
        }
        <h5>Add New Event</h5>
        <EditForm Model="newEvent" OnValidSubmit="AddEvent">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="form-group">
                <label for="eventname">Event Name</label>
                <InputText id="eventname" class="form-control" @bind-Value="newEvent.eventname" />
                <label for="appointment-time">Select Time:</label>
                <input type="time" id="appointment-time" @bind="SelectedTime" />
            </div>







            <button type="submit" class="btn btn-primary">Add Event</button>
        </EditForm>
    </div>

}
else
{

    <body style="background-image:url('https://files.oaiusercontent.com/file-PiQRyXAyVisnvB4X2AiZuJ?se=2025-01-29T00%3A01%3A39Z&sp=r&sv=2024-08-04&sr=b&rscc=max-age%3D604800%2C%20immutable%2C%20private&rscd=attachment%3B%20filename%3D6f3a34c5-c404-40dc-adf4-4525e23e3150.webp&sig=o2zceawf9Fmdr2IZ6aJsk8dQLQg9lKUp0qYokYNzpAc%3D')">
    </body>
    <h5>Add New Event</h5>
    <EditForm Model="newEvent" OnValidSubmit="AddEvent">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="form-group">
            <label for="eventname">Event Name</label>
            <InputText id="eventname" class="form-control" @bind-Value="newEvent.eventname" />
            <label for="appointment-time">Select Time:</label>
            <input type="time" id="appointment-time" @bind="SelectedTime" />
        </div>







        <button type="submit" class="btn btn-primary">Add Event</button>
    </EditForm>
}

<style>
    body {
    background-color: #111827;
    color: #f9fafb;
    font-family: Arial, sans-serif;
    }

    .details-container {
    max-width: 900px;
    margin: 40px auto;
    padding: 20px;
    background: #1e293b;
    border-radius: 12px;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    }

    h5 {
    color: #60a5fa;
    text-align: center;
    margin: 24px 0 16px 0;
    font-size: 1.4rem;
    }

    .events-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 24px;
    background: #1f2937;
    border: 1px solid #374151;
    border-radius: 8px;
    overflow: hidden;
    }

    .events-table th,
    .events-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #374151;
    }

    .events-table th {
    background-color: #374151;
    color: #f9fafb;
    font-weight: 600;
    font-size: 0.95rem;
    }

    .events-table td {
    font-size: 0.95rem;
    color: #d1d5db;
    }

    .events-table tr:hover {
    background: #2c3e50;
    }

    .form-group {
    margin-bottom: 16px;
    }

    .form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 6px;
    font-size: 0.95rem;
    }

    .form-control {
    width: 100%;
    padding: 10px;
    border: 1px solid #374151;
    border-radius: 6px;
    background: #1f2937;
    color: #f9fafb;
    font-size: 1rem;
    transition: border-color 0.3s ease;
    }

    .form-control:focus {
    border-color: #3b82f6;
    outline: none;
    }

    .btn-primary {
    background-color: #3b82f6;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1rem;
    transition: background-color 0.3s ease;
    width: 100%;
    }

    .btn-primary:hover {
    background-color: #60a5fa;
    }

    .btn-danger {
    background-color: #ef4444;
    color: white;
    border: none;
    padding: 8px 14px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.95rem;
    transition: background-color 0.3s ease;
    }

    .btn-danger:hover {
    background-color: #dc2626;
    }

    table .btn-danger {
    width: 100%;
    text-align: center;
    }
</style>


@code {
    [Parameter]
    public string Date { get; set; }
    public DateTime selectedDate;
    public Student userS = null;
    public Teacher userT = null;
    //   private List<Event> dayEvents = new List<Event>();
    private Event newEvent = new Event();
    private List<Event>events = new List<Event>();
    public DateTime SelectedTime;
    private HubConnection hubConnection;
    string notification = "";
    string conid = "";
    protected override async Task OnInitializedAsync()
    {
        hubConnection = new HubConnectionBuilder()
        .WithUrl(navigationManager.ToAbsoluteUri("/NotificationHub"))
        .WithAutomaticReconnect()
        .Build();

        hubConnection.On<string, string>("GetNotificationToInformIAdedYouAsFriend", async (email, notification) =>
        {
            this.notification = email + " " + notification;
            await js.InvokeVoidAsync("alert", @$"{this.notification}");
            ToastService.ShowInfo($"{email}: {notification}");
            await InvokeAsync(StateHasChanged);
        });
        hubConnection.On<string, string, int>("GetToInformTeacherThatIwantPrivateClass", async (email, notification, eventrandomcod) =>
        {
            this.notification = email + " " + notification;

            ToastService.ShowInfo($"{email}: {notification}");
            await InvokeAsync(StateHasChanged);
        });
        hubConnection.On<string, string>("GetNotificationToInformAboutNewEvent", async (email, notification) =>
        {
            this.notification = email + " " + notification;
            await js.InvokeVoidAsync("alert", @$"{this.notification}");
            ToastService.ShowInfo($"{email}: {notification}");
            await InvokeAsync(StateHasChanged);
        });
        Console.WriteLine("RRR");
        await hubConnection.StartAsync();




    }
    protected override async void OnParametersSet()
    {
        if (Date == null)
        {
            selectedDate = DateTime.Now;
        }

        else
        {

            selectedDate = DateTime.Parse(Date);


            StateHasChanged();
        }
    }

    private async Task<List<Event>> LoadEventsForDay(DateTime date)
    {
        try
        {
            if (userS != null)
            {
                Console.WriteLine($"Fetching events for {date:yyyy-MM-dd}");
                selectedDate = DateTime.Parse(Date);
                EventDB eventDB = new EventDB();
                List<Event> events = await eventDB.GetAllEventsForSpecificStudenAndDate(userS.Id, selectedDate);
                //      Console.WriteLine($"Fetched {events.Count} events from database.");
                return events ?? new List<Event>(); 
            }
            else{
                Console.WriteLine($"Fetching events for {date:yyyy-MM-dd}");
                EventDB eventDB = new EventDB();
                List<Event> events = await eventDB.GetAllEventsForSpecificTeacherAndDate(userT.Id, date);
                return events ?? new List<Event>();
            }

        }
        catch (Exception e)
        {
            Console.WriteLine(e);

        }
        return null;
    }

    private async Task AddEvent()
    {
        try
        {
            Random random = new Random();
            int x = random.Next(-10000000, 10000000);

            bool s = true;
            bool success = false;
            Console.WriteLine("Attempting to add a new event...");
            EventDB eventDB = new EventDB();
            DateTime dateTime = selectedDate;
            TimeSpan timeSpan = new TimeSpan(int.Parse(SelectedTime.ToString("HH")), int.Parse(SelectedTime.ToString("mm")), 0);
            dateTime = dateTime + timeSpan;
            Console.WriteLine(dateTime.Hour);
            newEvent.date = dateTime; // Keep the same day
            newEvent.randomuniqcode = x.GetHashCode(); // Generate a unique code
            newEvent.kinofevent = "private event";
            newEvent.enddate = dateTime.AddHours(1);
            if (userT != null)
            {
                newEvent.teacherid = userT.Id;
                success = await eventDB.insertEvent(newEvent);
            }

            else if (userS != null)
            {
                StudentInEventDB studentInEventDB = new StudentInEventDB();
                StudentInEvent studentInEvent = new StudentInEvent(userS.Id, newEvent.randomuniqcode);
                success = await eventDB.insertEvent(newEvent);
                s = await studentInEventDB.insertStedentInEvent(studentInEvent);
            }
            if (success && s)
            {
                Console.WriteLine("Event added successfully to the database.");
                // if (events==null)
                // {

                // }
                // else
                events.Add(newEvent);
                Console.WriteLine($"Added event: {newEvent.eventname} at {newEvent.date:HH:mm}");
                newEvent = new Event(); // Reset the form
            }
            else
            {
                Console.WriteLine("Failed to add event to the database.");
            }
        }
        catch (Exception e)
        {
            Console.WriteLine(e);
        }
        StateHasChanged();
    }

        /*private async Task DeleteEvent(int uniqueCode)
         {
             Console.WriteLine($"Attempting to delete event with unique code: {uniqueCode}");
             var eventDB = new EventDB();
    // await eventDB.DeleteAsync(new Dictionary<string, object> { { "randomuniqcode", uniqueCode } });
    events.RemoveAll(e => e.randomuniqcode == uniqueCode);
             Console.WriteLine($"Event with unique code {uniqueCode} deleted.");

         }*/
    protected override async Task OnAfterRenderAsync(bool firstRender)///
    {

    if (firstRender)
    {
        Console.WriteLine("first re");



        var user1 = await MySession.GetAsync<Student>("student");
        if (user1.Success)
        {
            userS = user1.Value;
            
            events = await LoadEventsForDay(selectedDate);
                if (!await StaticNotificationHub.IsThisSpecificEmailExistIn_multyconidFORnotifications(userS.email))
                {

                    List<string> notifCon = new List<string>();
                    notifCon.Add(hubConnection.ConnectionId);
                    StaticNotificationHub.multyconidFORnotificationsForstudents.Add(userS.email, notifCon);
                }
                else
                {
                    conid = hubConnection.ConnectionId;
                    List<string> strings = StaticNotificationHub.multyconidFORnotificationsForstudents[userS.email];
                    strings.Add(conid);
                    StaticNotificationHub.multyconidFORnotificationsForstudents[userS.email] = strings;
                }

                StateHasChanged();
            }
            var user2 = await MySession.GetAsync<Teacher>("teacher");
            if (user2.Success)
            {
                userT = user2.Value;
                events = await LoadEventsForDay(selectedDate);
                if (!await StaticNotificationHub.IsThisSpecificEmailExistIn_multyconidFORnotificationsFORteacher(userT.email))
                {

                    List<string> notifCon = new List<string>();
                    notifCon.Add(hubConnection.ConnectionId);
                    StaticNotificationHub.multyconidFORnotificationsForteacher.Add(userT.email, notifCon);
                }
                else
                {
                    conid = hubConnection.ConnectionId;
                    List<string> strings = StaticNotificationHub.multyconidFORnotificationsForteacher[userT.email];
                    strings.Add(conid);
                    StaticNotificationHub.multyconidFORnotificationsForteacher[userT.email] = strings;
                }
                StateHasChanged();
            }
            if (!user1.Success&&!user2.Success)
            {
            
               
                    navigationManager.NavigateTo("/");
                
            }

        }
        // else if (!string.IsNullOrEmpty(myConId))
        // {
        //     await setconid();
        // }

    }
        

}
