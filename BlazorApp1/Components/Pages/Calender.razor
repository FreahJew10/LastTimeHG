@page "/calender"
@inject NavigationManager navigationManager
@inject IJSRuntime js
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject ProtectedSessionStorage MySession
@using Microsoft.AspNetCore.SignalR.Client
@using Models
@using DBL
@using Hubs

<h3>Custom Weekly Scheduler</h3>
<div class="scheduler-container">
    <div class="scheduler-header">
        <button @onclick="PreviousWeek">&lt;</button>
        <h4>@weekStartDate.ToString("yyyy, MM dd") - @weekStartDate.AddDays(6).ToString("yyyy, MM dd")</h4>
        <button @onclick="NextWeek">&gt;</button>
    </div>

    <div class="scheduler-grid">
        <!-- Day headers -->
        <div class="time-column"></div>
        @foreach (var day in Enumerable.Range(0, 7))
        {
            <div class="day-header">
                <a href="DetailsOfDay/@weekStartDate.AddDays(day).ToString("yyyy,MM dd")">
                    @weekStartDate.AddDays(day).ToString("dddd, MMM dd")
                </a>
            </div>
        }

        <!-- Time slots -->
        @foreach (var hour in Enumerable.Range(8, 11))
        {
            <div class="time-column">@hour:00</div>
            @foreach (var day in Enumerable.Range(0, 7))
            {
                var currentDateTime = weekStartDate.AddDays(day).AddHours(hour);
                var nextHour = currentDateTime.AddHours(1);

                var eventsForTimeSlot = events
                .Where(ev => ev.date != null && ev.enddate != null &&
                ev.date < nextHour && ev.enddate > currentDateTime)
                .ToList();

                <div class="scheduler-cell">
                    @if (eventsForTimeSlot.Any())
                    {
                        @foreach (var ev in eventsForTimeSlot)
                        {
                            <div class="scheduler-event">
                                <span>@ev.eventname</span> <br />
                                <small>Kind: @ev.kinofevent</small> <br />
                                <small>@ev.date.ToString("hh:mm tt") - @ev.enddate.ToString("hh:mm tt")</small>
                            </div>
                        }
                    }
                </div>
            }
        }
    </div>
</div>

<style>
    .scheduler-container {
        max-width: 1200px;
        margin: 20px auto;
        font-family: Arial, sans-serif;
    }

    .scheduler-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .scheduler-grid {
        display: grid;
        grid-template-columns: 80px repeat(7, 1fr);
        border: 1px solid #ccc;
    }

    .time-column {
        font-weight: bold;
        text-align: center;
        padding: 5px;
        background-color: #f5f5f5;
        border: 1px solid #ccc;
        border-right: none; /* Remove space between hour rows */
    }

    .day-header {
        font-weight: bold;
        text-align: center;
        padding: 10px;
        background-color: #e0f7fa;
        border: 1px solid #ccc;
    }

    .scheduler-cell {
        border: 1px solid #ccc;
        padding: 5px;
        background-color: white;
        height: 60px;
    }

    .scheduler-event {
        background-color: #007bff;
        color: white;
        padding: 5px;
        border-radius: 4px;
        font-size: 12px;
    }
</style>


@code {
    private DateTime weekStartDate = DateTime.Today.AddDays(-(int)DateTime.Today.DayOfWeek + (int)DayOfWeek.Sunday);
    private List<Event> events = new List<Event>();
    private bool isLoading = true;
    private Student userS;
    EventDB eventDB1 = new EventDB();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var userResult = await MySession.GetAsync<Student>("student");
            if (userResult.Success)
            {
                userS = userResult.Value;
                await LoadEventsForWeekAsync();
            }
        }
    }

    private async Task LoadEventsForWeekAsync()
    {
        if (userS != null)
        {
            isLoading = true;

            var startOfWeek = weekStartDate;
            var endOfWeek = weekStartDate.AddDays(7);

            var fetchedEvents = await GetEventsForTimeRange(startOfWeek, endOfWeek);
            events = fetchedEvents?.ToList() ?? new List<Event>();

            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task<IEnumerable<Event>> GetEventsForTimeRange(DateTime start, DateTime end)
    {
        EventDB eventDB = new EventDB();
        var result = await eventDB.GetEventsForStudentInRange(userS.Id, start, end);
        return result ?? Enumerable.Empty<Event>();
    }

    private async Task PreviousWeek()
    {
        weekStartDate = weekStartDate.AddDays(-7);
        await LoadEventsForWeekAsync();
    }

    private async Task NextWeek()
    {
        weekStartDate = weekStartDate.AddDays(7);
        await LoadEventsForWeekAsync();
    }
}