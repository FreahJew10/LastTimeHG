@page "/teacher-classes"
@using Models
@using DBL
@inject IJSRuntime js
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject ProtectedSessionStorage MySession
@inject Microsoft.AspNetCore.Components.NavigationManager navigationManager
@using Hubs
@using Microsoft.AspNetCore.SignalR.Client
@using Blazored.Toast.Services
@inject IToastService ToastService

<style>
    body {
    background-color: #1e1e2f;
    color: #fff;
    font-family: 'Segoe UI', sans-serif;
    }

    .page-container {
    display: flex;
    height: 100vh;
    overflow: hidden;
    }

    .class-list {
    flex: 1;
    padding: 2rem;
    overflow-y: auto;
    }

    .class-item {
    background: #2b2b40;
    margin-bottom: 1rem;
    padding: 1rem;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s;
    }

    .class-item:hover {
    background: #383854;
    }

    .sidebar {
    width: 50%;
    background: #252535;
    padding: 2rem;
    border-left: 1px solid #444;
    transition: transform 0.4s ease;
    transform: translateX(100%);
    position: relative;
    }

    .sidebar.open {
    transform: translateX(0%);
    }

    .sidebar h3 {
    margin-bottom: 1rem;
    border-bottom: 1px solid #444;
    padding-bottom: 0.5rem;
    }

    .students-list {
    max-height: 300px;
    overflow-y: auto;
    background-color: #2f2f45;
    padding: 1rem;
    border-radius: 6px;
    margin-bottom: 1.5rem;
    }

    .students-list li {
    padding: 0.5rem 0;
    border-bottom: 1px solid #444;
    }

    input, select, button {
    width: 100%;
    padding: 0.5rem;
    margin-top: 0.5rem;
    border-radius: 5px;
    border: none;
    background-color: #3a3a4f;
    color: white;
    }

    button {
    background-color: #0078d7;
    transition: 0.3s;
    cursor: pointer;
    }

    button:hover {
    background-color: #0055aa;
    }

    .close-btn {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: transparent;
    color: #ccc;
    font-size: 1.5rem;
    cursor: pointer;
    border: none;
    }
</style>

<div class="page-container">
    <div class="class-list">
        <h2>Your Classes</h2>
        @if (classes is not null)
        {
            @foreach (Event cls in classes)
            {
                <div class="class-item" @onclick="() => OpenSidebar(cls)">
                    <strong>@cls.eventname</strong><br />

                </div>
            }
        }
    </div>

    <div class="sidebar @(selectedClass is not null ? "open" : "")">
        @if (selectedClass != null)
        {
            <button class="close-btn" @onclick="CloseSidebar">×</button>
            @* <h3>@selectedClass.SubjectName - @selectedClass.StartTime.ToString("f")</h3> *@

            <h4>Students:</h4>
            <ul class="students-list">
                @foreach (Person student in studentsInClass)
                {
                    <li>@student.first_name @student.last_name</li>
                }
            </ul>

            <h4>Add Event to This Class</h4>
            <input placeholder="Event Title" @bind="newEventTitle" />
            <select @bind="newEventType">
                <option value="">-- Select Type --</option>
                <option value="test">Test</option>
                <option value="homework">Homework</option>

            </select>
            <input placeholder="@DateTime.Now" type="datetime-local" @bind="newEndEventTime" />
            <button @onclick="AddNewEvent">Add Event</button>
        }
    </div>
</div>

@code {


    private List<Event> classes = new();
    private Event? selectedClass;
    private List<Person> studentsInClass = new();
    public Teacher? userT { get; set; }
    public PersonStudentDB personStudentDB = new PersonStudentDB();
    public EventDB eventDB = new EventDB();
    private string newEventTitle = "";
    private string newEventType = "";
    private DateTime newEndEventTime = DateTime.Now;
    HubConnection hubConnection = null;
    string notification = "";
    protected override async Task OnInitializedAsync()
    {
        hubConnection = new HubConnectionBuilder()
        .WithUrl(navigationManager.ToAbsoluteUri("/NotificationHub"))
        .WithAutomaticReconnect()
        .Build();


        Console.WriteLine("RRR");
        await hubConnection.StartAsync();




    }

    private async Task OpenSidebar(Event cls)
    {
        selectedClass = cls;
        StudentInEventDB studentInEventDB = new StudentInEventDB();
        List<StudentInEvent> lst=await studentInEventDB.GetAllStudentInEvent_ForSpesificEvent(cls.randomuniqcode);
        studentsInClass = await personStudentDB.GetAllPersonForStudentInEvent(lst);
    }

    private void CloseSidebar()
    {
        selectedClass = null;
        studentsInClass.Clear();
        newEventTitle = "";
        newEventType = "";
        newEndEventTime = DateTime.Now;
    }

    private async Task AddNewEvent()
    {
        if (!string.IsNullOrEmpty(newEventTitle) && !string.IsNullOrEmpty(newEventType) && newEndEventTime != DateTime.Now)
        {
            if (newEndEventTime > DateTime.Now)
            {
                EventDB eventDB = new EventDB();
                StudentInEventDB studentInEventDB = new StudentInEventDB();
                Random random = new Random();
                int x = new Random().Next(-1000000, int.MaxValue);
                Event @event = new Event(newEventTitle, newEndEventTime.AddHours(-1), userT.Id, newEventType, x, newEndEventTime);
                List<StudentInEvent> studentInEvents = new List<StudentInEvent>();
                List<string> emails = new List<string>();
                foreach (Person stu in studentsInClass)
                {
                    studentInEvents.Add(new StudentInEvent(stu.Id, x));
                    emails.Add(stu.email);
                }
                if (await eventDB.insertEvent(@event))
                {
                    await studentInEventDB.insertStedentInEvent(studentInEvents);



                    await hubConnection.SendAsync("SendNotificationToInformAboutNewEvent", emails, "new " + @event.kinofevent, userT.email);
                    ToastService.ShowSuccess("you set new " + @event.kinofevent);


                }
            }
            else
            {
                ToastService.ShowError("You can not enter date before today");
            }

        }
        else
        {
            ToastService.ShowError("fiLl all the values");
        }
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {

            {
                var user2 = await MySession.GetAsync<Teacher>("teacher");
                if (user2.Success)
                {
                    userT = user2.Value;
                    classes = await eventDB.GetAllClassesForTeacer(userT.Id);
                    StateHasChanged();
                }
                else
                {
                    navigationManager.NavigateTo("/");
                }

            }
            StateHasChanged();
        }
    }
}
