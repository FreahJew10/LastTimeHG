@page "/admin"
@using Models
@using DBL
@inject IJSRuntime js
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject ProtectedSessionStorage MySession
@inject Microsoft.AspNetCore.Components.NavigationManager navigationManager
@using Hubs
@using Microsoft.AspNetCore.SignalR.Client
@using Blazored.Toast.Services
@inject IToastService ToastService
<h3>Admin</h3>
@if(userT!=null&&userT.isprivate==3)
{
<div class="admin-container">

    <div class="section">
        <h2>Add New Subject</h2>
        <input placeholder="Subject Name" @bind="newSubject" />
        <button @onclick="AddSubject">Add Subject</button>
        <div class="list-box">
            <ul>
                @foreach (Subject subject in subjects)
                {
                    <li>@subject.subjectName</li>
                }
            </ul>
        </div>
    </div>
    <h2>create new class</h2>
    <div class="section">

        <h6>select teacher</h6>
        <select @bind="TeacherId">
            <option value="">-- Select Teacher --</option>
            @foreach (Teacher teacher in teachers)
            {
                <option value="@teacher.Id">@teacher.first_name @teacher.last_name</option>
            }
        </select>
        <h6>select student</h6>
        <div class="friends-list">
            @foreach (Person friend in pagedStudents)
            {
                <div class="friend-item">
                    <input type="checkbox"
                    checked="@selectedstudent.Contains(friend)"
                    @onchange="(e) => ToggleFriendSelection(friend, (bool?)e.Value)" />
                    <label>@friend.first_name @friend.email</label>
                </div>
            }
        </div>

        <div class="pagination">
            <button @onclick="()=> ChangePage(currentPage - 1)" disabled="@(currentPage == 1)">Previous</button>
            <span>Page @currentPage of @totalPages</span>
            <button @onclick="()=> ChangePage(currentPage + 1)" disabled="@(currentPage == totalPages)">Next</button>
        </div>
        <input type="text" placeholder="give class name" @bind="classname" />

        <button @onclick="CreateEvent">Create Event</button>
    </div>

</div>
}
<style>

    .pagination {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 1rem;
    gap: 10px;
    }

    .pagination button {
    padding: 0.5rem 1rem;
    background-color: #0078d7;
    border: none;
    color: white;
    border-radius: 5px;
    cursor: pointer;
    }

    .pagination button:disabled {
    background-color: #444;
    cursor: not-allowed;
    }



    body {
    background-color: #1e1e2f;
    color: #fff;
    font-family: 'Segoe UI', sans-serif;
    }

    .admin-container {
    max-width: 1000px;
    margin: auto;
    padding: 2rem;
    }

    h2 {
    border-bottom: 1px solid #444;
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
    }

    .section {
    margin-bottom: 2rem;
    background-color: #2a2a3b;
    padding: 1.5rem;
    border-radius: 10px;
    box-shadow: 0 0 10px #000;
    }

    input, select, button {
    margin: 0.5rem 0;
    padding: 0.5rem;
    border-radius: 5px;
    border: none;
    }

    input, select {
    width: 100%;
    background-color: #3a3a4f;
    color: #fff;
    }

    button {
    background-color: #0078d7;
    color: #fff;
    cursor: pointer;
    transition: 0.2s ease-in-out;
    }

    button:hover {
    background-color: #005bb5;
    }

    .list-box {
    max-height: 200px;
    overflow-y: auto;
    background: #2c2c40;
    padding: 0.5rem;
    border-radius: 5px;
    }
</style>

@code {
    private List<Person> students = new List<Person>();
    private List<Teacher> teachers = new();
    private List<Subject> subjects = new();
    public List<Person> selectedstudent = new List<Person>();
    public teacherDB teacherDB = new teacherDB();
    public PersonStudentDB studentDB = new PersonStudentDB();
    public SubjectDB subjectDB = new SubjectDB();
    DateTime StartTime = DateTime.Now;
    DateTime EndTime = new DateTime(2025,6,20);
    private string newSubject = "";
    public Event Nevent;
    int TeacherId;
    int studentid;
    string classname="";
    int currentPage = 1;
    int pageSize = 10;
    int totalPages => (int)Math.Ceiling((double)students.Count / pageSize);
    public Teacher ?userT { get; set; }

    List<Person> pagedStudents => students
        .Skip((currentPage - 1) * pageSize)
        .Take(pageSize)
        .ToList();
    private void ChangePage(int newPage)
    {
        if (newPage >= 1 && newPage <= totalPages)
        {
            currentPage = newPage;
        }
    }

    protected override async Task OnInitializedAsync()
    {
    
    }
    private void ToggleFriendSelection(Person friend, bool? isChecked)
    {
        if (isChecked == true)
        {
            if (!selectedstudent.Contains(friend))
                selectedstudent.Add(friend);
        }
        else
        {
            selectedstudent.Remove(friend);
        }
    }
    private async Task AddSubject()
    {
        if (!string.IsNullOrWhiteSpace(newSubject))
        {
            if(await   subjectDB.InsertSubject(newSubject))
            {
                ToastService.ShowSuccess("success");
            }
        }
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
           
            {
                var user2 = await MySession.GetAsync<Teacher>("teacher");
                if (user2.Success)
                {
                    userT = user2.Value;
                    students = await studentDB.GetAllStudents();
                    teachers = await teacherDB.GetAllPublicTeachers();
                    subjects = await subjectDB.SelectAllSubjects();
                    StateHasChanged();
                }

            }
            StateHasChanged();
        }
    }
    private async Task CreateEvent()
    {
        EventDB eventDB = new EventDB();
        StudentInEventDB studentInEventDB = new StudentInEventDB();

        Random random = new Random();
        int x = random.Next(int.MinValue, int.MaxValue);
        Nevent = new Event(classname, StartTime, TeacherId,"class", x, EndTime);
        List<StudentInEvent> studentInclass = new List<StudentInEvent>();
        foreach (Person item in selectedstudent)
        {
            StudentInEvent studentInEvent = new StudentInEvent(item.Id, x);
            studentInclass.Add(studentInEvent);

        }

        if( await eventDB.insertEvent(Nevent))
        {
            await studentInEventDB.insertStedentInEvent(studentInclass);
            ToastService.ShowSuccess("success");
        }
        else{
            ToastService.ShowError("something went wrong");
        }
        

    }
}
